# План реализации графиков с использованием Plotly.js

Цель: добавить в интерфейс небольшие графики рядом с каждым циклом заряда (мини-графики, отображающие полные данные конкретного цикла) и один крупный граф внизу страницы, который показывает все данные файла.

## 1. Краткое описание
- Для каждой строки в текущем выводе (каждого цикла) показываем компактный интерактивный график (sparkline / мини-график), визуализирующий полные данные этого цикла (напряжение/ток/время).
- Внизу вывода добавляем большой интерактивный график, который отображает весь набор данных (все циклы) с возможностью фильтрации, масштабирования и выделения диапазонов.
- Библиотека: Plotly.js (в React-приложении рекомендуется использовать `react-plotly.js` с `plotly.js-dist-min` или `plotly.js-basic-dist` для снижения размера бандла).

## 2. Требования к данным
- Структура входа: для каждого цикла — массив точек {time: number, voltage: number, current?: number} или эквивалентный токен-представление, используемое в проекте (см. `domain/*`, `parsing/*`).
- Для мини-графиков используется весь массив точек цикла (но может потребоваться downsampling для больших циклов).
- Для большого графика объединяются все циклы по времени относительно начала файла или по относительному времени цикла — в зависимости от требований представления.

## 3. Расположение в UI
- Мини-график правее/слева от метрик цикла в существующем компоненте результатов (в проекте — вероятно `ui/ResultsTable.tsx`).
  - Высота мини-графика: 48–80px (настраиваемая). Горизонтально — компактная полоска рядом с данными цикла.
  - Мини-график кликабелен: при клике открывает модальное окно или разворачивает детальный вид для данного цикла (можно переиспользовать компонент FullDatasetChart в режиме single-cycle).
- Большой график: размещается внизу страницы с возможностью сворачивания/разворачивания и с контролами фильтрации (список циклов, чекбоксы, диапазон времени).

## 4. Интеграция Plotly
- Добавить зависимости:
  - `plotly.js-dist-min` (или `plotly.js-basic-dist`) и `react-plotly.js` в package.json
- Создать обёртку `src/ui/charts/PlotlyWrapper.tsx`, которая будет задавать общие настройки (цвета, шрифты, темы, опции экспортирования) и унифицировать обработку resize/обновлений.

## 5. Компоненты
- `MiniCycleChart.tsx`
  - Пропсы: `points: Point[]`, `height?: number`, `onClick?: () => void` и т. п.
  - Рендерит компактную линию (voltage vs time) и, при наличии, вторую линию (current) либо всплывающую подсказку по hover.
  - Встроить в `ResultsTable` рядом с каждым циклом.
- `FullDatasetChart.tsx`
  - Пропсы: `allCycles: Cycle[]`, `activeCycleId?: string`, `onSelectRange?: (range) => void`.
  - Поддерживает overlay нескольких циклов, выбор одного цикла, агрегацию, downsampling, экспорт PNG/CSV.
  - Контролы: список циклов, чекбоксы для выбора метрик (voltage/current), ползунки для обрезки по времени, кнопки зума/сброса.
- `CycleDetailsModal.tsx` (опционально)
  - Появляется при клике на мини-график, показывает `FullDatasetChart` в режиме single-cycle с дополнительными метриками.

## 6. Обработка данных и оптимизация
- Добавить утилиты в `src/domain` или `src/export`:
  - `downsample(points, maxPoints)` — уменьшает количество точек (например, LTTB или простая выборка по шагу) для ускорения рендера.
  - `flattenCycles(allCycles)` — подготавливает данные для Big Chart (с возможной нормализацией времени).
  - Фильтрация/агрегация по циклам.
- Для больших файлов использовать:
  - отложенную генерацию мини-графиков (ленивая отрисовка при скролле),
  - Web Worker (в проекте уже есть парсерный воркер в `worker/`) для тяжёлых преобразований данных.

## 7. Тестирование
- Unit-тесты для утилит трансформации данных (`tests/*`), покрытие edge-cases и пустых данных.
- Компонентные тесты (Jest + React Testing Library) для `MiniCycleChart` (рендер, событие клика) и `FullDatasetChart` (рендер множественных циклов, переключение фильтров).
- Визуальная проверка: добавить storybook-стори или скриншот-тесты для регрессий визуализации.

## 8. Производительность и бандл
- Выбор `plotly.js-basic-dist` или `plotly.js-dist-min` для уменьшения размера бандла.
- Возможность динамической подгрузки `react-plotly.js` (lazy import) чтобы не грузить библиотеку для пользователей, которые не используют графики.

## 9. Приёмочные критерии
- Для каждого цикла в таблице отображается мини-график, корректно показывающий профиль напряжения по времени для этого цикла.
- Мини-график интерактивен (hover — подсказка; клик — открывает детальный вид).
- На странице доступен большой граф всех данных с возможностью выбора/фильтрации циклов и масштабирования по времени.
- Производительность: на файлах до N точек (N — согласовать; например, 100k) взаимодействие остаётся откликом < 200мс при нормализации/досэмплинге.

## 10. План работ (приблизительно)
1. Установить зависимости Plotly и добавить обёртку — 1 день
2. Реализовать `MiniCycleChart` и вставить в `ResultsTable` — 1–2 дня
3. Реализовать `FullDatasetChart` и контролы фильтрации — 2–3 дня
4. Добавить утилиты трансформации и оптимизации; интегрировать воркер при необходимости — 1–2 дня
5. Тесты, документация и доработки — 1 день

---

Если нужно, могу дополнительно:
- подготовить конкретный PR с установкой зависимостей и начальным компонентом `MiniCycleChart`;
- написать примерный API-компонента и stub-интеграцию в `ResultsTable.tsx`.
